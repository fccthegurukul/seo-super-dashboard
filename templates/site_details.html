{% extends "layout.html" %}

{% block content %}
<a href="{{ url_for('dashboard') }}" class="btn btn-secondary mb-3"><i class="fa fa-arrow-left"></i> Back to Dashboard</a>
<h2 class="mb-3">Scan Details for <span class="text-primary">{{ site_name.replace('_', '/').replace('-', '.') }}</span></h2>

<ul class="nav nav-tabs" id="myTab" role="tablist">
  <li class="nav-item" role="presentation"><button class="nav-link active" id="latest-tab" data-bs-toggle="tab" data-bs-target="#latest-tab-pane" type="button" role="tab">Latest Scan</button></li>
  <li class="nav-item" role="presentation"><button class="nav-link" id="compare-tab" data-bs-toggle="tab" data-bs-target="#compare-tab-pane" type="button" role="tab">Compare Scans</button></li>
</ul>

<div class="tab-content border border-top-0 p-3 rounded-bottom" id="myTabContent">
  <div class="tab-pane fade show active" id="latest-tab-pane" role="tabpanel">
    <h4>Latest Scan: <small class="text-muted">{{ scan_files[0] if scan_files else 'N/A' }}</small></h4>
    <!-- (Content from analyzer_results.html, modified to be here) -->
    {% set status_counts = namespace(ok=0, redirects=0, client_errors=0, server_errors=0, other=0) %}
    {% for item in data %}{% if item.http_status == 200 %}{% set status_counts.ok = status_counts.ok + 1 %}{% elif item.http_status in [301, 302, 307, 308] %}{% set status_counts.redirects = status_counts.redirects + 1 %}{% elif item.http_status is number and 400 <= item.http_status < 500 %}{% set status_counts.client_errors = status_counts.client_errors + 1 %}{% elif item.http_status is number and item.http_status >= 500 %}{% set status_counts.server_errors = status_counts.server_errors + 1 %}{% else %}{% set status_counts.other = status_counts.other + 1 %}{% endif %}{% endfor %}
    <div class="row g-3 my-3">
        <div class="col"><div class="card text-center p-2"><h5 class="card-title">Total URLs</h5><p class="card-text fs-2">{{ data|length }}</p></div></div>
        <div class="col"><div class="card text-center p-2 text-bg-success"><h5 class="card-title">OK (2xx)</h5><p class="card-text fs-2">{{ status_counts.ok }}</p></div></div>
        <div class="col"><div class="card text-center p-2 text-bg-warning"><h5 class="card-title">Redirects (3xx)</h5><p class="card-text fs-2">{{ status_counts.redirects }}</p></div></div>
        <div class="col"><div class="card text-center p-2 text-bg-danger"><h5 class="card-title">Client Errors (4xx)</h5><p class="card-text fs-2">{{ status_counts.client_errors }}</p></div></div>
    </div>
    <div class="table-responsive" style="max-height: 70vh; overflow-y: auto;">
        <table class="table table-striped table-hover">
            <thead><tr><th>URL</th><th>Status</th><th>Category</th></tr></thead>
            <tbody>{% for item in data %}<tr><td><small><a href="{{ item.url }}" target="_blank">{{ item.url[:90] }}{% if item.url|length > 90 %}...{% endif %}</a></small></td><td>{% if item.http_status == 200 %}<span class="badge bg-success">200 OK</span>{% elif item.http_status in [301, 302, 307, 308] %}<span class="badge bg-warning">Redirect</span>{% elif item.http_status is number and item.http_status >= 400 %}<span class="badge bg-danger">{{ item.http_status }}</span>{% else %}<span class="badge bg-secondary">{{ item.http_status }}</span>{% endif %}</td><td><span class="badge rounded-pill text-bg-light">{{ item.category }}</span></td></tr>{% endfor %}</tbody>
        </table>
    </div>
  </div>
  <div class="tab-pane fade" id="compare-tab-pane" role="tabpanel">
    <h4>Compare two scans to see changes</h4>
    <div class="row g-3 align-items-center">
      <div class="col-auto"><label>Compare:</label></div><div class="col-auto"><select class="form-select" id="compareFileA">{% if scan_files|length > 1 %}<option value="{{ scan_files[1] }}">{{ scan_files[1] }}</option>{% endif %}{% for file in scan_files[2:] %}<option value="{{ file }}">{{ file }}</option>{% endfor %}</select></div>
      <div class="col-auto"><label>with (Newer):</label></div><div class="col-auto"><select class="form-select" id="compareFileB">{% if scan_files %}<option value="{{ scan_files[0] }}">{{ scan_files[0] }}</option>{% endif %}{% for file in scan_files[1:] %}<option value="{{ file }}">{{ file }}</option>{% endfor %}</select></div>
      <div class="col-auto"><button class="btn btn-warning" id="runComparison">Compare</button></div>
    </div>
    <div id="comparison-results" class="mt-4"></div>
  </div>
</div>
{% endblock %}
{% block scripts %}
<script>
document.getElementById('runComparison')?.addEventListener('click', function() {
    const fileA = document.getElementById('compareFileA').value;
    const fileB = document.getElementById('compareFileB').value;
    if (!fileA || !fileB) { alert("Please select two files to compare."); return; }
    if (fileA === fileB) { alert("Please select two different files."); return; }

    const resultsDiv = document.getElementById('comparison-results');
    resultsDiv.innerHTML = '<div class="spinner-border" role="status"></div>';
    fetch('/api/compare', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ site_name: '{{ site_name }}', file_a: fileA, file_b: fileB })
    }).then(res => res.json()).then(data => {
        const renderList = (items) => `<ul>${items.map(i => `<li><small><a href="${i.url}" target="_blank">${i.url}</a></small></li>`).join('') || '<li>None</li>'}</ul>`;
        const renderUpdated = (items) => `<ul>${items.map(i => `<li><small><a href="${i.url}" target="_blank">${i.url}</a></small> - <span class="text-warning">${Object.keys(i.changes).join(', ')} changed</span></li>`).join('') || '<li>None</li>'}</ul>`;
        
        resultsDiv.innerHTML = `<div class="accordion">
            <div class="accordion-item"><h2 class="accordion-header"><button class="accordion-button" data-bs-toggle="collapse" data-bs-target="#added">Added URLs (${data.added.length})</button></h2><div id="added" class="accordion-collapse collapse show"><div class="accordion-body">${renderList(data.added)}</div></div></div>
            <div class="accordion-item"><h2 class="accordion-header"><button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#removed">Removed URLs (${data.removed.length})</button></h2><div id="removed" class="accordion-collapse collapse"><div class="accordion-body">${renderList(data.removed)}</div></div></div>
            <div class="accordion-item"><h2 class="accordion-header"><button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#updated">Updated URLs (${data.updated.length})</button></h2><div id="updated" class="accordion-collapse collapse"><div class="accordion-body">${renderUpdated(data.updated)}</div></div></div>
        </div>`;
    });
});
</script>
{% endblock %}