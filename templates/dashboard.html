{% extends "layout.html" %}

{% block content %}
<div class="row g-4">
    <div class="col-lg-6">
        <div class="card h-100">
            <div class="card-header"><h3><i class="fa-solid fa-sitemap text-primary"></i> Sitemap Analyzer</h3></div>
            <div class="card-body">
                <form action="{{ url_for('start_scan_route') }}" method="post">
                    <div class="mb-3"><label for="url" class="form-label">Enter Site URL</label><input type="url" class="form-control" id="url" name="url" required placeholder="https://www.example.com"></div>
                    <button type="submit" class="btn btn-primary w-100"><i class="fa-solid fa-magnifying-glass"></i> Start Scan</button>
                </form>
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card h-100">
            <div class="card-header"><h3><i class="fa-solid fa-wand-magic-sparkles text-info"></i> Content Scraper</h3></div>
            <div class="card-body">
                <form action="{{ url_for('start_scrape_route') }}" method="post">
                    <div class="mb-3"><label for="article_url" class="form-label">Article URL</label><input type="url" class="form-control" id="article_url" name="article_url" required placeholder="https://example.com/blog/my-article"></div>
                    <div class="mb-3"><label for="publisher_name" class="form-label">Publisher Name</label><input type="text" class="form-control" id="publisher_name" name="publisher_name" required placeholder="Your Brand Name"></div>
                    <button type="submit" class="btn btn-info w-100"><i class="fa-solid fa-feather-pointed"></i> Scrape & Generate</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="row g-4 mt-2">
    <div class="col-lg-4">
        <div class="card h-100">
            <div class="card-header"><h3><i class="fa-solid fa-robot text-success"></i> AI Content Generator</h3></div>
            <div class="card-body">
                <form action="{{ url_for('ai_generate_content') }}" method="post">
                    <div class="mb-3">
                        <label for="prompt" class="form-label">AI Prompt</label>
                        <textarea class="form-control" id="prompt" name="prompt" rows="3" required placeholder="Enter your content generation prompt..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-success w-100"><i class="fa-solid fa-magic"></i> Generate Content</button>
                </form>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card h-100">
            <div class="card-header"><h3><i class="fa-solid fa-eye text-warning"></i> Competitor Monitor</h3></div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('competitors') }}" class="btn btn-warning"><i class="fa-solid fa-users"></i> Manage Competitors</a>
                    <form action="{{ url_for('manual_competitor_scan') }}" method="post" class="d-inline">
                        <button type="submit" class="btn btn-outline-warning w-100"><i class="fa-solid fa-search"></i> Scan Now</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card h-100">
            <div class="card-header"><h3><i class="fa-solid fa-paper-plane text-danger"></i> Auto Publisher</h3></div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('publishing') }}" class="btn btn-danger"><i class="fa-solid fa-cog"></i> Publishing Settings</a>
                    <form action="{{ url_for('process_queue') }}" method="post" class="d-inline">
                        <button type="submit" class="btn btn-outline-danger w-100"><i class="fa-solid fa-play"></i> Process Queue</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<hr class="my-4">

<div class="row g-4">
    <div class="col-md-8">
        <h3><i class="fa-solid fa-tasks"></i> Task Queue</h3>
        <div class="table-responsive">
            <table class="table align-middle">
                <thead><tr><th>Type</th><th>Target URL</th><th style="width: 40%;">Status</th><th>Action</th></tr></thead>
                <tbody>
                {% if not tasks %}
                    <tr><td colspan="4" class="text-center py-4 text-muted">No tasks started yet.</td></tr>
                {% else %}
                    {% for task_id, task_info in tasks.items() %}
                        <tr data-task-id="{{ task_id }}"><td id="type-{{task_id}}">...</td><td id="url-{{task_id}}">...</td><td id="status-{{task_id}}">...</td><td id="action-{{task_id}}">...</td></tr>
                    {% endfor %}
                {% endif %}
                </tbody>
            </table>
        </div>
    </div>
    <div class="col-md-4">
        <div class="row g-3">
            <div class="col-12">
                <h3><i class="fa-solid fa-database"></i> Scanned Sites</h3>
                <div class="list-group" style="max-height: 200px; overflow-y: auto;">
                    {% for site in scanned_sites %}
                        <a href="{{ url_for('site_details', site_name=site) }}" class="list-group-item list-group-item-action">{{ site.replace('_', '/').replace('-', '.') }}</a>
                    {% else %}
                        <div class="list-group-item text-muted">No sites scanned yet.</div>
                    {% endfor %}
                </div>
            </div>
            <div class="col-12">
                <h3><i class="fa-solid fa-lightbulb"></i> Content Opportunities</h3>
                <div id="opportunities-list" class="list-group" style="max-height: 200px; overflow-y: auto;">
                    <div class="list-group-item text-muted">Loading opportunities...</div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const tasks = {{ tasks|tojson }};
    let activeIntervals = {};

    function updateTaskUI(taskId, data) {
        const typeCell = document.getElementById(`type-${taskId}`);
        const urlCell = document.getElementById(`url-${taskId}`);
        const statusCell = document.getElementById(`status-${taskId}`);
        const actionCell = document.getElementById(`action-${taskId}`);

        if (!statusCell) return;
        
        typeCell.innerHTML = data.type === 'Sitemap Scan' ? `<span class="badge bg-primary">Sitemap</span>` : `<span class="badge bg-info">Scraper</span>`;
        if (data.type === 'AI Generation') typeCell.innerHTML = `<span class="badge bg-success">AI Gen</span>`;
        if (data.type === 'Competitor Scan') typeCell.innerHTML = `<span class="badge bg-warning">Competitor</span>`;
        if (data.type === 'Auto Generate & Publish') typeCell.innerHTML = `<span class="badge bg-danger">Auto Pub</span>`;
        if (data.type === 'Publishing Queue') typeCell.innerHTML = `<span class="badge bg-secondary">Queue</span>`;
        
        urlCell.innerHTML = `<small>${data.url}</small>`;
        
        let statusHtml = '';
        if (data.status === 'running' || data.status === 'queued') {
            const progress = data.progress || 0;
            statusHtml = `<div class="progress" style="height: 25px;"><div class="progress-bar progress-bar-striped progress-bar-animated bg-secondary" style="width: ${progress}%">${progress}%</div></div><small class="text-muted">${data.message}</small>`;
        } else if (data.status === 'complete') {
            statusHtml = `<span class="badge bg-success fs-6">Complete</span>`;
            actionCell.innerHTML = `<a href="/results/${taskId}" class="btn btn-sm btn-success">View Results</a>`;
            if (activeIntervals[taskId]) clearInterval(activeIntervals[taskId]);
        } else if (data.status === 'error') {
            statusHtml = `<span class="badge bg-danger fs-6">Error</span><br><small class="text-danger" style="font-size: 0.8em;">${data.message}</small>`;
            if (activeIntervals[taskId]) clearInterval(activeIntervals[taskId]);
        }
        statusCell.innerHTML = statusHtml;
    }

    function fetchTaskStatus(taskId) {
        fetch(`/task-status/${taskId}`)
            .then(response => response.json())
            .then(data => {
                if(data.status !== 'not_found') {
                    tasks[taskId] = data; // Update local state
                    updateTaskUI(taskId, data);
                }
            })
            .catch(error => console.error(`Error for ${taskId}:`, error));
    }

    for (const taskId in tasks) {
        updateTaskUI(taskId, tasks[taskId]);
        if (tasks[taskId].status !== 'complete' && tasks[taskId].status !== 'error') {
            activeIntervals[taskId] = setInterval(() => fetchTaskStatus(taskId), 3000);
        }
    }
    
    // Load content opportunities
    fetch('/api/content-opportunities')
        .then(response => response.json())
        .then(opportunities => {
            const opportunitiesList = document.getElementById('opportunities-list');
            if (opportunities.length === 0) {
                opportunitiesList.innerHTML = '<div class="list-group-item text-muted">No opportunities found</div>';
            } else {
                opportunitiesList.innerHTML = opportunities.slice(0, 5).map(opp => 
                    `<div class="list-group-item">
                        <small><strong>${opp.competitor}</strong></small><br>
                        <small class="text-muted">${opp.analysis.generated_content ? opp.analysis.generated_content.substring(0, 100) + '...' : 'Analysis available'}</small>
                    </div>`
                ).join('');
            }
        })
        .catch(error => {
            document.getElementById('opportunities-list').innerHTML = '<div class="list-group-item text-danger">Error loading opportunities</div>';
        });
});
</script>
{% endblock %}